<!DOCTYPE html>
<html lang="ja">

<head>
  <!-- META -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="uisual" content="Made with Uisual (uisual.com)">
  <meta name="author" content="#">
  <meta name="description" content="#">
  <meta name="referrer" content="unsafe-url">
  <meta name="robots" content="index, follow">
  <!-- SPEED -->
  <link rel="preconnect" href="https://res.cloudinary.com">
  <link rel="dns-prefetch" href="https://res.cloudinary.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <!-- LINK -->
  <link rel="me" href="#">
  <link rel="canonical" href="#">
  <link rel="icon" type="image/png" href="#" sizes="48x48">
  <!-- PERFORMANCE -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
  <link rel="preload" as="style" href="style.css">
  <link rel="stylesheet" href="style.css">
  <!-- TITLE -->
  <title>SHOGI</title>
  <style>
    body {
      font-family: "游明朝", YuMincho, "Hiragino Mincho ProN W3", "ヒラギノ明朝 ProN W3", "Hiragino Mincho ProN", "HG明朝E", "ＭＳ Ｐ明朝", "ＭＳ 明朝", serif;
    }

    .w-100 {
      width: 100%;
    }

    .text-center {
      text-align: center;
    }

    .d-flex {
      display: flex;
    }

    table {
      border-collapse: collapse;
    }

    th {
      padding: 5px;
      background-color: #EBEBEB;
    }

    td {
      border-bottom: solid 2px #EBEBEB
    }

    #card td {
      border: solid 1px #BCBCBC;
    }

    #card thead td {
      background-color: #EBEBEB;
    }

    #card tbody td {
      background-color: #FFFFFF;
    }

    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #EBEBEB;
      border-radius: 3px;
    }

    #clear_history {
      color: #7a7a7a;
      text-decoration: underline;
      cursor: pointer;
      cursor: url(trash.png);

    }
  </style>
</head>

<body>
  <header role="banner" class="ui-section-header">
    <div class="ui-layout-container">
      <div class="ui-section-header__layout ui-layout-flex">
        <!-- LOGO -->
        <a href="https://github.com/RekoGit/to-81-web" rel="noreferrer noopener" target="_blank" role="link"
          aria-label="#">
          <svg version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
            x="0px" y="0px" viewBox="0 0 512 512" style="width: 32px; height: 32px; opacity: 1;" xml:space="preserve">
            <style type="text/css">
              .st0 {
                fill: #4B4B4B;
              }
            </style>
            <g>
              <path class="st0" d="M404.824,53.177H107.177L0,228.28v147.902h49.682c-7.966,8.758-12.854,20.478-12.854,33.234
                  c0,13.6,5.551,26.029,14.469,34.938c8.909,8.925,21.338,14.477,34.938,14.469c13.601,0.008,26.028-5.544,34.931-14.469
                  c8.925-8.909,14.477-21.338,14.477-34.938c0-12.756-4.889-24.476-12.855-33.234h266.425c-7.965,8.758-12.854,20.478-12.846,33.234
                  c-0.008,13.6,5.551,26.029,14.468,34.938c8.902,8.925,21.331,14.477,34.931,14.469c13.609,0.008,26.029-5.544,34.939-14.469
                  c8.918-8.909,14.469-21.338,14.469-34.938c0-12.756-4.89-24.476-12.855-33.234H512v-11.674V228.28L404.824,53.177z M120.259,76.533
                  h271.482l93.24,152.342H27.019L120.259,76.533z M110.238,419.559c-1.964,4.653-5.285,8.651-9.443,11.468
                  c-4.173,2.81-9.123,4.432-14.56,4.44c-3.625-0.008-7.022-0.724-10.136-2.041c-4.66-1.965-8.658-5.292-11.468-9.45
                  c-2.81-4.173-4.44-9.124-4.44-14.56c0-3.626,0.724-7.022,2.041-10.136c1.965-4.653,5.285-8.659,9.442-11.468
                  c4.174-2.81,9.124-4.44,14.561-4.44c3.625,0,7.021,0.731,10.136,2.04c4.661,1.965,8.659,5.293,11.468,9.451
                  c2.81,4.173,4.44,9.115,4.447,14.553C112.279,413.048,111.548,416.444,110.238,419.559z M449.769,419.559
                  c-1.965,4.653-5.286,8.651-9.443,11.468c-4.173,2.81-9.123,4.432-14.56,4.44c-3.624-0.008-7.021-0.724-10.128-2.041
                  c-4.66-1.965-8.666-5.292-11.476-9.45c-2.81-4.173-4.439-9.124-4.439-14.56c0-3.626,0.724-7.022,2.04-10.136
                  c1.965-4.653,5.285-8.659,9.45-11.468c4.166-2.81,9.116-4.44,14.553-4.44c3.625,0,7.021,0.731,10.136,2.04
                  c4.669,1.965,8.659,5.293,11.476,9.451c2.81,4.173,4.432,9.115,4.44,14.553C451.818,413.048,451.086,416.444,449.769,419.559z
                   M488.644,352.835H23.356V241.447h465.289V352.835z" style="fill: rgb(75, 75, 75);"></path>
              <path class="st0" d="M378.445,90.362h-244.89L79.457,209.837h11.141h341.945L378.445,90.362z M220.278,104.732h71.446l2.818,16.487
                  h-77.082L220.278,104.732z M215.008,135.588h81.986l3.457,20.272h-88.9L215.008,135.588z M190.205,195.459h-88.466l11.422-25.23
                  h81.354L190.205,195.459z M196.967,155.86h-77.294l9.177-20.272h71.583L196.967,155.86z M135.36,121.219l7.464-16.487h62.878
                  l-2.817,16.487H135.36z M204.788,195.459l4.311-25.23h93.812l4.302,25.23H204.788z M306.306,104.732h62.879l7.462,16.487h-67.531
                  L306.306,104.732z M311.568,135.588h71.583l9.184,20.272h-77.302L311.568,135.588z M317.493,170.23h81.345l11.423,25.23h-88.466
                  L317.493,170.23z" style="fill: rgb(75, 75, 75);"></path>
            </g>
          </svg>
        </a>
        <!-- MENU -->
        <a href="https://chrome.google.com/webstore/detail/to81/ffnlhcjmddghncbcpackccofdabihban" role="link"
          aria-label="#" class="ui-component-button ui-component-button-small ui-component-button-primary"
          target="_blank" rel="noopener noreferrer">Chrome
          Extension</a>
      </div>
    </div>
  </header>
  <main role="main">
    <section class="ui-section-hero">
      <div class="ui-layout-container">
        <div class="ui-layout-column-6 ui-layout-column-center">
          <h1>星取表作成</h1>
          <a class="ui-text-intro">入力された名前に応じて対局カードを作成するだけのページです。入力された内容はブラウザに保存されます。履歴を削除したいときは<span
              id="clear_history">ここ</span>をクリックしてください。</a>
        </div>
      </div>
    </section>

    <section class="ui-section-feature">
      <div class="ui-layout-container">
        <div class="ui-section-feature__layout ui-layout-grid ui-layout-grid-2">
          <!-- MEMBERS -->
          <div class="w-100">
            <table id="members" class="w-100 text-center">
              <thead>
                <tr>
                  <th>名前</th>
                  <th>R</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
            <svg id="add_row" version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512"
              style="width: 32px; height: 32px; opacity: 1; float: right;" xml:space="preserve">
              <style type="text/css">
                .st0 {
                  fill: #4B4B4B;
                }
              </style>
              <g>
                <path class="st0" d="M359.244,224.004h-59.988c-6.217,0-11.258-5.043-11.258-11.258v-59.992c0-6.215-5.039-11.254-11.256-11.254
              h-41.486c-6.217,0-11.258,5.039-11.258,11.254v59.992c0,6.215-5.039,11.258-11.256,11.258h-59.988
              c-6.219,0-11.258,5.039-11.258,11.258v41.484c0,6.215,5.039,11.258,11.258,11.258h59.988c6.217,0,11.256,5.039,11.256,11.258
              v59.984c0,6.219,5.041,11.258,11.258,11.258h41.486c6.217,0,11.256-5.039,11.256-11.258v-59.984
              c0-6.219,5.041-11.258,11.258-11.258h59.988c6.217,0,11.258-5.043,11.258-11.258v-41.484
              C370.502,229.043,365.461,224.004,359.244,224.004z" style="fill: rgb(131, 131, 131);"></path>
                <path class="st0" d="M256,0C114.613,0,0,114.617,0,256c0,141.387,114.613,256,256,256c141.383,0,256-114.613,256-256
              C512,114.617,397.383,0,256,0z M256,448c-105.871,0-192-86.129-192-192c0-105.867,86.129-192,192-192c105.867,0,192,86.133,192,192
              C448,361.871,361.867,448,256,448z" style="fill: rgb(131, 131, 131);"></path>
              </g>
            </svg>
          </div>

          <p class="ui-text-intro">参加者の一覧を入力してボタンを押してください
            <a href="javascript:void(0)" id="create_card"
              class="ui-component-button ui-component-button-small ui-component-button-primary">星取表作成</a>
          </p>

        </div>
      </div>
    </section>

    <section class="ui-section-testimonial">
      <div class="ui-layout-container">
        <div class="ui-layout-column-8 ui-layout-column-center">
          <h2>星取表</h2>
          <span id="info" class="ui-text-intro">?をクリックして対局結果を入力できます</span>
          <div class="ui-layout-flex ui-component-button-small">
            <span id="info" class="">クリップボードからGoogleSpreadsheetに貼り付ける場合は<br>貼り付け後に[テキストを列に分割]を選択してください。</span>&nbsp;
            <a href="javascript:void(0)" id="copy_card"
              class="ui-component-button ui-component-button-small ui-component-button-primary">クリップボードにコピー</a>&nbsp;
            <a href="javascript:void(0)" id="copy_card_lite"
              class="ui-component-button ui-component-button-small ui-component-button-primary">クリップボードにコピー(レート/勝敗を含まない)</a>
          </div>
          <table id="card" class="w-100 text-center">
            <thead>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </main>
  <footer role="contentinfo" class="ui-section-footer">
    <div class="ui-layout-container">
      <div class="ui-section-footer__layout ui-layout-flex">
        <!-- COPYRIGHT -->
        <p class="ui-section-footer--copyright ui-text-note"><small>&copy; 2023 ringodaisuki</small></p>
      </div>
    </div>
  </footer>
  <script>
    const STORAGE_MEMBERS = 'MEMBERS';
    const ROUND_TO_BREAK = 'ROUND_TO_BREAK';

    let stored_members = {};
    let table_members = document.querySelector('#members tbody');
    let table_head = document.querySelector('#card thead');
    let table_body = document.querySelector('#card tbody');

    const add_row = () => {
      let row = document.createElement('tr');
      let col1 = document.createElement('td');
      let name = document.createElement('input');
      name.setAttribute("type", "text");
      let col2 = document.createElement('td');
      let rate = document.createElement('input');
      rate.setAttribute("type", "number");
      col1.appendChild(name);
      col2.appendChild(rate);
      row.appendChild(col1);
      row.appendChild(col2);
      table_members.appendChild(row);
    }

    const add_rows = (num) => {
      for (let i = 0; i < num; i++) {
        add_row()
      }
    }

    const copy_card = () => {
      copy_card_to_clipboard(false);
    }

    const copy_card_lite = () => {
      copy_card_to_clipboard(true);
    }

    const copy_card_to_clipboard = (lite) => {
      let data;
      let separator = ',';
      let rows = document.querySelectorAll("#card tr[id^='me']");
      // Construct csv
      let csv = [];
      for (let i = 0; i < rows.length; i++) {
        let row = [], cols = rows[i].querySelectorAll('td, th');
        for (let j = 0; j < cols.length; j++) {
          if (lite) {
            if (j >= 1 && j <= 3) {
              continue;
            }
          }
          // Clean innertext to remove multiple spaces and jumpline (break csv)
          if (lite) {
            data = cols[j].innerText.replace(/(\r\n|\n|\r|\?|\○|\●)/gm, '').replace(/(\s\s)/gm, ' ');
          } else {
            data = cols[j].innerText.replace(/(\r\n|\n|\r|\?)/gm, '').replace(/(\s\s)/gm, ' ');
          }
          // Escape double-quote with double-double-quote (see https://stackoverflow.com/questions/17808511/properly-escape-a-double-quote-in-csv)
          data = data.replace(/"/g, '""');
          // Push escaped string
          row.push('"' + data + '"');
        }
        csv.push(row.join(separator));
      }

      navigator.permissions.query({ name: "clipboard-write" }).then((result) => {
        if (result.state === "granted" || result.state === "prompt") {
          /* write to the clipboard now */
          navigator.clipboard.writeText(csv.join('\n')).then(() => {
            /* clipboard successfully set */
          }, () => {
            /* clipboard write failed */
            console.log('clipboard write failed')
          });
        }
      });

    }

    const create_card = () => {
      let name = '';
      let rate = 0;
      let info_member = '';
      let info_break = '';

      // メンバーリストを初期化
      stored_members = {};

      // メンバーを読み込み(一行目のタイトルは飛ばす)
      for (let i = 0; i < table_members.rows.length; i++) {
        name = table_members.rows[i].children[0].children[0].value;
        rate = table_members.rows[i].children[1].children[0].value;

        if (name == '') {
          // 名前が未入力でもレートが入力されているなら、処理はしないがエラーメッセージは表示する
          if (rate != '') {
            info_member += `${i} 行目は名前が未入力のため処理対象外\n`;
          }
        } else {
          // 名前が入力されている場合
          if (rate == '') {
            info_member += `${i} 行目はレートが未入力のためR900として処理\n`;
            rate = 900;
          }
          stored_members[name] = rate;
        }
      }

      // localStorageに一時保存(異なるキーで直前に保存されている可能性があるため、一旦削除してから書き込む)
      localStorage.removeItem(STORAGE_MEMBERS);
      localStorage.setItem(STORAGE_MEMBERS, JSON.stringify(stored_members));



      // 参加者の数を取得
      num_members = Object.keys(stored_members).length;
      if (num_members % 2 == 1) {
        // 参加者が奇数の場合、回ごとに休みの人が出るので、ダミーを追加
        stored_members[ROUND_TO_BREAK] = 0;
      }

      // 回数(n + n%2 - 1)を算出  /* 9〜10人 = 9回、　7〜8人 = 7回、 5〜6人 = 5回 */  -> 結局、ダミーを投入することにしたのでこの計算はn-1でもよい
      let rounds = num_members + num_members % 2 - 1;

      // 1回あたりの対局数((n + n%2) / 2)を算出 /*１回休みもカウント： 9〜10人 = 5回、7〜8人 = 4回、 5〜6人 = 3回 */
      let games_per_round = (num_members + num_members % 2) / 2;

      let account_members;

      // 星取表を初期化
      let hositorihyo = {};
      Object.keys(stored_members).forEach(account => hositorihyo[account] = []);

      let idx_gote;     //末尾からi番目を先頭からのインデックスに変換して格納
      // let aux_gote = true; 
      for (let i = 0; i < rounds; i++) {
        // キーを初期化
        account_members = Object.keys(stored_members);

        for (let j = 0; j < games_per_round; j++) {
          // 先頭と末尾からi番目の人をマッチング
          sente = account_members.shift();
          // 後手の要素番号をセット
          if (account_members.length == 1) {
            idx_gote = 0;
          } else if (account_members.length > i) {
            idx_gote = account_members.length - i - 1;
          } else {
            // 末尾から((i - 1) % 2)番目の要素
            idx_gote = account_members.length - ((i - 1) % 2) - 1;; //配列の残りがiに満たなくなってからのインデックス（0 <-> 1)
          }

          gote = account_members[idx_gote];
          account_members.splice(idx_gote, 1);

          // 後手の方がレートが低い場合は、先手/後手を入れ替える
          if (Number(stored_members[sente]) < Number(stored_members[gote])) {
            [sente, gote] = [gote, sente];
          }

          // 星取表に格納
          hositorihyo[sente].push(gote);
          hositorihyo[gote].push(sente);
        }
      }
      // document.getElementById('info').innerHTML = info_break;

      // 星取表を初期化
      table_head.innerHTML = '';
      table_body.innerHTML = '';
      let row;

      // headerをセット
      row = document.createElement('tr');
      ['アカウント', 'レート', '勝', '負'].concat([...hositorihyo[sente]].map((_, i) => i + 1)).forEach(val => {
        let col = document.createElement('td');
        col.innerHTML = val;
        row.appendChild(col);
      });
      table_head.appendChild(row);

      // bodyをセット
      let key_id = 'me_';
      for (key in hositorihyo) {
        if (key != ROUND_TO_BREAK) {
          row = document.createElement('tr');
          row.id = key_id + key;
          [key, stored_members[key], '', ''].concat(hositorihyo[key]).forEach(val => {
            let col = document.createElement('td');
            if (val == ROUND_TO_BREAK) {
              col.innerHTML = "-";
            } else {
              if (row.childElementCount >= 4) {
                col.innerHTML = "<p>?</p>" + val;
              } else {
                col.innerHTML = val;
              }
            }
            row.appendChild(col);
          });
          table_body.appendChild(row);
        }
      }

      // 対局結果がクリックされた際の挙動を追加
      let cols = document.querySelectorAll('#card tbody td p');
      for (let i = 0; i < cols.length; i++) {
        cols[i].addEventListener('click', function () {
          console.log(this);
          let my_row = this.parentElement.parentElement;
          let opponent_id = key_id + this.parentElement.innerText.replace(/.\n\n/g, '');
          let opponent_row = document.getElementById(opponent_id);
          let me_in_opponent = document.evaluate("//tr[@id='" + opponent_id + "']//td[contains(text(), '" + my_row.children[0].innerText + "')]/p", document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;

          if (this.innerText == '●') {
            // 自分の勝ち数を加算
            this.innerText = '○';
            my_row.children[2].innerText = Number(my_row.children[2].innerText) + 1;
            my_row.children[3].innerText = Number(my_row.children[3].innerText) - 1;

            // 相手の負け数を加算
            me_in_opponent.innerText = '●'
            opponent_row.children[2].innerText = Number(opponent_row.children[2].innerText) - 1;
            opponent_row.children[3].innerText = Number(opponent_row.children[3].innerText) + 1;


          } else if (this.innerText == '○') {
            // 自分の負け数を加算
            this.innerText = '●';
            my_row.children[3].innerText = Number(my_row.children[3].innerText) + 1
            my_row.children[2].innerText = Number(my_row.children[2].innerText) - 1

            // 相手の勝ち数を加算
            me_in_opponent.innerText = '○'
            opponent_row.children[3].innerText = Number(opponent_row.children[3].innerText) - 1;
            opponent_row.children[2].innerText = Number(opponent_row.children[2].innerText) + 1;


          } else {
            // 自分の負け数は変更しない
            this.innerText = '○';
            my_row.children[2].innerText = Number(my_row.children[2].innerText) + 1

            // 相手の勝ち数は変更しない  
            me_in_opponent.innerText = '●'
            opponent_row.children[3].innerText = Number(opponent_row.children[3].innerText) + 1;

          }
          //



          // thisはli[i]にあたる
          // this.remove();
        });
      };


      if (info_member != '') {
        alert('対戦表を作成しました。\n' + info_member);
      }
      document.getElementById("info").parentNode.scrollIntoView({
        behavior: 'smooth',
        block: 'start',
      });

    }

    const clear_history = () => {
      table_members.innerHTML = '';
      add_rows(6);
      localStorage.removeItem(STORAGE_MEMBERS);
    }

    window.onload = (event) => {
      let storage = localStorage.getItem(STORAGE_MEMBERS);
      if (storage !== null) {
        stored_members = JSON.parse(storage);
        let i = 0;
        for (m in stored_members) {
          add_row();
          table_members.children[i].children[0].children[0].value = m;
          table_members.children[i].children[1].children[0].value = stored_members[m];
          i++;
        }
      } else {
        add_rows(6);
      }
      document.getElementById('add_row').addEventListener('click', add_row);
      document.getElementById('create_card').addEventListener('click', create_card);
      document.getElementById('copy_card').addEventListener('click', copy_card);
      document.getElementById('copy_card_lite').addEventListener('click', copy_card_lite);
      document.getElementById('clear_history').addEventListener('click', clear_history);
    };

  </script>
</body>

</html>